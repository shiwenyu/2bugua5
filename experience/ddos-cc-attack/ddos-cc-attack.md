# 记一次CC攻击

自从去年年中因为内网机器防火墙问题，导致线上服务连续不可用之后，确实也风平浪静了挺长时间了。

人无远虑，必有近忧。在和平时期没有加强内功，到了关键时刻，各种问题都一起暴露出来了。


## CC第一波，敌人在测试攻击？

周日下午4：30，技术老大突然在开发运维群里，发了句"啥情况"，下意识线上是不是挂了？赶紧打开APP，果然各种失败。由于今年也
出过几次服务挂掉的情况，还以为是不是内网某个机器网卡又坏了，又或者是内网某些机器的防火墙又被打开了？


### 重启 node

OP在群里，说`node`层有大量调用后端超时，询问是否要重启下`node`，而且看样子，`node`进程确实重启过了，估计是`pm2`重启的吧(这里也有疑问，到底什么原因，
导致`pm2`重启了node进程)。好吧，还是要尊重OP的意见，那就重启`node`服务吧，虽然，显然，`node`服务本身并没有异常，因为还在
不断的打错误日志，请求后端服务超时。 But, whatever，万一重启下`node`服务，就都好了呢，谁知道呢……

理想很丰满，现实却相当骨干。重启`node`服务，线上依然挂着……

### 重启后端服务

`node`依然请求后端超时，OP在**内网nginx**直接`curl`后端服务，根本访问不到。找到原因了，后端服务挂了，要重启后端服务。
后端服务重启完，看看APP，嗯，貌似都恢复了。

还没来得及松口气，线上报警又开始了……再刷APP，嗯，又挂了

### 终极绝招，限流

我们在日常生活中，或多或少都会积累一些宝贵的经验，用来解决一些很难搞定的问题，比如：
平常使用电脑中，遇到电脑莫名其妙的问题，都会祭出终极大招：重启电脑；
平时开发中，遇到浏览器页面异常，也有终极大招：重启浏览器。

在线上服务运维这里，连重启这样的大招都搞不定了，那就只能请出终极绝招——限流——了！

问下OP，目前PC端域名限流什么情况，答限的 5000 并发。等等，我们什么时候能撑5000了？印象中，去年那次压测，得出的结论是比较小的，
神马时候这么流弊，都能扛5000了，不对，事实证明，还是没能hold住……

赶紧调到合适的值……

又是一顿猛如虎的操作，限流，done；页面访问，OK；APP刷新，perfect！

周末的公司，就几个人在，领导们定在周一下午复盘，看看到底啥情况。

晚上，8：30，离开公司


## CC第二波，说真的，不开玩笑

你能想到，我们还来不及复盘，周一上午8：30，攻击者又早早的来搞事情了……
这时候，我隐约感到，周末下午，只是牛刀小试，只是攻击者想要测试下自己的工具、方法是否有效么……


### 继续限流，重启

赶紧看看限流，莫不是又莫名其妙的到了5000？看了，还是在昨晚的数值。但是发现，有1个子域名，限流是3000……
不行，全站挂着，必须先恢复服务。
再限流，继续降低并发数；再重启，自下而上，全部重启。

还是那样猛如虎的操作，还是那样熟悉的结果。服务刚恢复一会儿，又报警，又挂掉。


### 来源IP：`0.0.0.0`

从CDN日志上，拿到了10点一个小时的日志，根据我的统计，并没有某些IP的请求量很大，最大的也才4W。但是根据`use-agent`统计，
1个小时共300W条，某一个`user-agent`单独占了200W条，并且主要刷我们PC首页和注册页面的几个接口。确实是被人搞了，而且对手
比较高级，IP分布比较均衡。

拿这些`ip`一筹莫展的时候，OP某个老大在群里说，发现 `0.0.0.0` 的来源IP占据了60%以上的请求！怎么会有用户的IP是`0.0.0.0`呢？
as far as i know，用户请求网站，应该不会是 `0.0.0.0` 这样的吧？要不直接在 **外网nginx** 或者 **F5** 上，拒绝这个IP？
OP咨询了安全公司，说这个IP，**不能直接屏蔽**，有可能是 **CDN** 没有给我们IP，或者给了错误的IP，需要咨询下 CDN。OP继续咨询
CDN服务商，什么情况下会给我们这个IP。不知道CDN的技术同学怎么说的，听说是扯了很多底层的东西，扯了很多内部封包、解包的东西，
然后可能答案就是他们没拿到用户IP吧……

但是线上服务一直挂着呢，总不能看着这个IP干瞪眼吧。要不在**外网nginx**拒绝这个IP？但是 `0.0.0.0`确实很特殊，经过讨论，老大们
害怕拒绝这个IP，会拒绝所有来源IP，所以没敢尝试(其实可以在另外一台nginx上尝试下的)。要不在CDN上直接拒绝掉这个IP？OP说了，
CDN上不能配置这个，不能根据来源IP屏蔽。WTF！啥玩意儿CDN？没事的时候，什么高防，什么抗多少多少DDOS攻击，出事的时候，尼玛连
个根据IP屏蔽都搞不定？！(其实，那个啥，别人CDN可以配置，只是我们不知道……)

OP们不断从日志里找出访问量最大的IP，不断封禁。线上服务依然时好时坏。

快13:00点了，攻击者还是有点任性了，消停了一会儿，给了我们几分钟的时间，下楼吃个午饭……

刚吃完，果然又报警了


### 首页静态化

攻击者确实对我们做了研究，基本上最大的量在刷PC段首页，而首页几乎会请求后端所有服务的接口，刷1个页面，相当于刷了所有后端服务，机智。

既然首页耍的量最大，那要不暂时首页静态化，直接给HTML，不请求后端接口，虽然这会牺牲掉一些功能，比如用户登录之后，首页显示未登录，
但目前服务都挂了，页面都打不开，还谈什么登录呢？

嗯，首页生成一份静态HTML文件，给OP同学。10分支左右，配置好了，访问首页，额，怎么有个302跳转到静态文件呢？
去掉302吧，希望走内部rewrite，不redirect。大概半个小时吧，嗯，算了，302就302吧，先上吧。

然而下午发现，当天有政府部分在验收，首页静态化之后，一看就是HTML文件，不是弄虚作假么？又果断去掉了首页静态化配置。
即使服务挂着，也不能弄虚作假啊

### 扩容&缓存

后端决定对服务扩容了，OP一边准备。
缓存，是抗高并发的一剂良药(虽然经常有一些副作用)，后端同学同步的对一些耗时接口，增加数据缓存。


### 后面故事没怎么参与，忽略

周一晚上还有很多事故，比如CDN服务商真的异常了，不能走CDN了，然后OP又切到了什么高防；比如高防那里，静态资源也都全部回源，显然
F5上的限流远远不够，一个页面，静态资源可是几十个。

周二也不比周一差：原来F5上可以设置静态资源缓存(之前我们仍然不知道，还是F5的人来公司告诉我们的)，OP设置时，包含了 `.html` 文件，然而我们动态页面URL也是 `.html`，用户登陆后，
看到了别人的账号信息；比如在CDN上设置回源IP时，设置了错误的IP，错误的IP，IP……


## 一些思考

作为底层码农，还是想总结一些，本次持续2天的事故，都暴露出哪些问题，后续我们能够怎么来改进(out of my control)。


### 暴露的问题

* 显然，我们对我们每天都用到的系统、服务，**很不**熟悉！CDN明明可以根据来源IP做屏蔽，我们不知道；F5明明可以设置静态资源
缓存，我们不知道；nginx上，首页rewrite到一个静态HTML文件，不走302，我们不知道怎么配，服务挂着呢，百度也没找到答案
* 服务全链路，一个请求，到底要经过哪些东西，能够到达后端服务，我们不清楚！
* OP&DEV沟通渠道，哦，几乎没啥沟通，虽然有个沟通群。线上的限流数值，这么关键的东西，莫名其妙就被调到很大，引用高层的话"设置成5000，和没限流有啥区别"
* 服务没有良好的隔离。刷PC首页，导致PC和APP都挂了。
* 前端静态资源和动态请求，使用同一个域名，没有分离。
* 基础设施严重缺乏。论系统，我们有CDN/F5/WAF/nginx，然而，统计下最近的top url/ip，还要手动写 `awk` 来统计
* 一些脆弱的服务，没有上缓存，容量太小
* 权限太集中。线上日志，开发看不到；nginx日志，开发看不到；CDN后台，开发看不到。随便想看个什么东西，都必须找OP，一共2个干活的，
关键时刻还有1个找不到人……

### 可能的措施

* 还是多做基础功吧，夯实基础，不求太基础，只是用到的系统、工具、服务，还是稍微熟悉点
* 全链路，OP随时和开发同步。做任何修改，都应该 **提前** 知会开发
* 权限稍微放开点。没必要都集中到OP那。给开发的账号，没事就不要收回去了吧，平时可能没事都会看看的……
* 基础设施必须完善起来。各种常用的统计脚本，都应该ready
* 服务分离。PC的服务，是不是可以和APP的服务分离开，相互之间不影响
* 一些关键接口，尽量上缓存，数据短暂的不一致，比全站挂掉好
* 服务降级。面临CC攻击，是不是可以随时关掉某些服务，保证核心功能可用
* 快速扩容。是否可以随时扩容，在最短的时间内。自动化，自动化，自动化！
* 静态资源和动态请求，域名分离。单独搭建静态资源的域名和nginx集群。至少在配F5限流的时候，不用把静态资源考虑在内！
* 应用层，是不是可以针对单独刷接口的情况，配合session、token来解决
* nginx、F5、WAF层，是不是可以根据平常访问数据，针对单IP做限流


### 最想说的是

不要掩耳盗铃！不要掩耳盗铃！不要掩耳盗铃！

去年半夜来公司压测，好不容易得到一点系统的压力数据，还没完全弄明白，结果"马上天亮了，害怕影响正常用户访问"，没能继续压！

好像自己不压，别人就不会压似的……

压测，就应该常态化，常态化，常态化！

CC攻击防护，也应该常态化，常态化，常态化！


毕竟，

我们还有专门的安全团队的


## 相关资料

* [低成本实现百 Gbps DDoS/CC 攻击防护](https://juejin.im/entry/59f6cbf051882561a32637bf)
* [如何提升防御CC攻击的能力](https://segmentfault.com/a/1190000009264979)
* [CC攻击原理及防范方法](https://www.cnblogs.com/wpjamer/p/9030259.html)



                        ----- 时20180904 20:12 竣工于帝都五道口清华科技园


