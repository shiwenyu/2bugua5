# CDN增加响应的header

这周线上服务比较平稳，论坛又接力表演了。断断续续有用户反馈，APP里打开论坛白屏，但是开发测试没一个人能复现。

统计发现，反馈问题的用户，基本集中在广东地区，正好有同事在深圳出差，联系复现，果然能复现，Android白屏，iOS没问题。

咋一看，很像前端JS的兼容性问题，某个JS报错，导致前端渲染失败。再一想，论坛用的是discuz的，我们也没修改过，而且是近期才开始有反馈，显然用户之前是能正常访问的，应该和论坛代码没关系。全国大部分地区都能正常访问，应该也不是服务异常。嗯，莫不是CDN的问题，甩锅开始。

联系深圳同事，把访问论坛域名解析的IP地址拿到，在北京绑定IP，果然复现了。Android白屏，iOS没问题。interesting...

好吧，回到PC上，毕竟操作起来容易点。登录，打开论坛跳转页。额，怎么变成了文件下载……打开下载的文件，是正确的HTML内容……再看网络请求，这个样子的

![cdn add response header](./cdn-bbs-res-header.png)

显然，返回的 `Content-Type` 是错误的，导致浏览器把响应作为文件来下载，而不是渲染页面。这样看来，Android的 `Webview`面对 `Content-Type: application/octet-stream` 的返回内容，不会作为页面来渲染，貌似也能说通；iOS呢，可能并没有太遵守规范(我不确定规范是不是这样的)，反而能正确渲染这样的响应。

联系腾讯CDN同事，对方告知我们这个URL请求，响应中 **没有** 包含 `Content-Type`，他们会默认加一个，加一个，加一个……那为什么全国大部分地区都没有加呢？因为这个feature正在灰度中……

本来想在线上nginx直接修改，加上 `Content-Type`试试，但是还需要发邮件，邮件里要贴上 **具体的nginx配置** ，抄送各级大佬审批，然后才能改。嗯，好吧，这点小事，还是不要惊动上层了。联系后端同事在接口里加上吧，虽然按理说，本来就应该在服务上来加，只是我司这运维的这个，嗯，算了。

这个故事告诉我们，在接口里，记得加上 **贴切**的 `Content-Type`，你不加，可能会有好心人帮你加哦。


         ------- 时 2018年9月23日 16:44 竣工于帝都望京东保利国际


